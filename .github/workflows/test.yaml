name: test
# either manually started, or on a schedule
on: [ push, workflow_dispatch ]
jobs:
  test:
    # ubuntu
    runs-on: ubuntu-latest
    steps:
    # need the repo checked out
    - name: checkout repo
      uses: actions/checkout@v4
      with:
          submodules: recursive

    - name: Install iverilog
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y iverilog

    # Set Python up and install cocotb
    - name: Setup python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install cocotb 1.8.x
      shell: bash
      run: |
        pip install cocotb~=1.8.0
        pip install riscv-model~=0.6.6
        cocotb-config --libpython
        cocotb-config --python-bin

    - name: run tests
      run: |
        cd test && make
        # make will return success even if the test fails, so check for failure in the results.xml
        ! grep failure *results.xml
